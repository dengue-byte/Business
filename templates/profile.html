{% extends "base.html" %}

{% block title %}{{ _('Profile of') }} {{ profile_user.username }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
{% endblock %}

{% block content %}
<div class="profile-container">
    <div id="message-container"></div>
    <div class="profile-header">
       <div class="profile-avatar">
            {% if profile_user.profile_photo %}
                <img src="{{ url_for('uploaded_file', filename=profile_user.profile_photo) }}" 
                     alt="Photo de profil de {{ profile_user.username }}" 
                     class="profile-photo-clickable">
            {% else %}
                <span class="profile-initial">{{ profile_user.username[0]|upper }}</span>
            {% endif %}
        </div>
        <div class="profile-info">
            <h1>{{ profile_user.username }}</h1>
            <p>{{ _('Member since') }} {{ profile_user.member_since.strftime('%d %B %Y') }}</p>
            
            <div class="profile-stats">
                <div class="profile-rating">
                    <div class="stars">
                        {% for i in range(5) %}
                            <span class="star {% if i < avg_rating|round|int %}filled{% endif %}">?</span>
                        {% endfor %}
                    </div>
                    <span class="rating-text">{{ avg_rating }} {{ _('on') }} 5 ({{ rating_count }} {{ _('reviews') }})</span>
                </div>
                <div class="profile-interest">
    <i class="fa-solid fa-comments"></i>
    
    <span>{{ total_interest }} {{ _('interactions') }}</span> 
</div>
            </div>
            
            {% if g.user and g.user.id == profile_user.id %}
                <p class="profile-email">{{ profile_user.email }}</p>
            {% else %}
                <button id="chat-button" class="button-primary" 
                    data-author-id="{{ profile_user.id }}" 
                    {% if from_post_id %}data-post-id="{{ from_post_id }}"{% endif %}>
                    {{ _('Contact by Chat') }}
                </button>
            {% endif %}
        </div>
    </div>

    <div class="profile-content">
        <h2>{{ _('Ads of') }} {{ profile_user.username }}</h2>
        <div id="posts-list-container" class="posts-grid">
            {% if posts %}
                {% for post in posts %}
                <div class="post-card">
                    <button class="favorite-btn {% if g.user and post in g.user.favorite_posts %}favorited{% endif %}" data-post-id="{{ post.id }}" title="{{ _('Save') }}">
                        <svg width="24" height="24" viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"></path></svg>
                    </button>
                    <a href="{{ url_for('post_detail_page', post_id=post.id) }}" class="post-card-link">
                        {% if post.images %}
                            <div class="post-card-image" style="background-image: url({{ url_for('uploaded_file', filename=post.images[0].file_path) }});"></div>
                        {% endif %}
                        <div class="post-card-content">
                            <span class="post-card-category category-{{ post.category|lower }}">
                                {{ post.category }}
                            </span>
                            <h3>{{ post.title }}</h3>
                        </div>
                        <div class="post-card-footer-new">
                            <div class="footer-left">
                                {% if post.author.profile_photo %}
                                    <img src="{{ url_for('uploaded_file', filename=post.author.profile_photo) }}" class="author-photo-small">
                                {% else %}
                                    <div class="author-initial-small">{{ post.author.username[0]|upper }}</div>
                                {% endif %}
                                <span>{{ post.author.username }}</span>
                            </div>
                            <div class="footer-center">
    <i class="fa-solid fa-comments"></i>
    
    <span>{{ post.interest_count }}</span> 
</div>
                            <div class="footer-right">
                                <i class="fa-solid fa-eye"></i>
                                <span>{{ post.view_count }}</span>
                            </div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            {% else %}
                <p>{{ profile_user.username }} {{ _('has not published any ad yet.') }}</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="profile-reviews-container">
    <h3>{{ _('Received ratings') }} ({{ rating_count }})</h3>
    {% if ratings %}
        <div class="reviews-list">
            {% for rating in ratings %}
                <div class="review-card">
                    <div class="review-author">
                        <div class="author-avatar">
                            {% if rating.rater.profile_photo %}
                                <img src="{{ url_for('uploaded_file', filename=rating.rater.profile_photo) }}" class="author-photo-small" style="width:100%; height:100%;">
                            {% else %}
                                <span>{{ rating.rater.username[0]|upper }}</span>
                            {% endif %}
                        </div>
                        <div class="author-info">
                            <strong><a href="{{ url_for('profile_page', username=rating.rater.username) }}">{{ rating.rater.username }}</a></strong>
                            <span class="review-date">{{ rating.timestamp.strftime('%d %B %Y') }}</span>
                        </div>
                    </div>
                    <div class="review-content">
                        <div class="review-stars">
                            {% for i in range(5) %}
                                <span class="star {% if i < rating.stars %}filled{% endif %}">?</span>
                            {% endfor %}
                        </div>
                        {% if rating.comment %}
                            <p class="review-comment">{{ rating.comment }}</p>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>{{ profile_user.username }} {{ _('has not received any rating yet.') }}</p>
    {% endif %}
</div>

<div id="photo-modal" class="modal-overlay hidden">
    <button class="close-modal-btn">&times;</button>
    <div class="modal-content-photo">
        <img id="modal-image" src="" alt="Photo de profil en grand">
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/profile.js') }}"></script>
{% endblock %}